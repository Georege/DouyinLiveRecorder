# 直播录制文件命名规则

## 1. 概述

本文档详细说明 DouyinLiveRecorder 项目中直播视频录制文件和弹幕文件的命名设计规则，包括不同平台的处理方式、变量含义和文件格式。

## 2. 视频文件命名规则

### 2.1 基本格式

视频文件采用统一的命名格式，包含平台特定标识符、房间信息、主播信息、标题信息和时间戳：

```
{dy_id}_{room_id}_{anchor_name}_{title_in_name}_{timestamp}.{extension}
```

### 2.2 变量说明

| 变量 | 类型 | 说明 | 默认值 |
|------|------|------|--------|
| dy_id | 字符串 | 抖音平台特定标识符 | 抖音：实际值<br>其他平台：使用 room_id |
| room_id | 字符串 | 直播间标识符 | 从平台API获取或从URL提取<br>无值时为 "None" |
| anchor_name | 字符串 | 主播名称 | 从平台API获取 |
| title_in_name | 字符串 | 直播标题（可选） | 有标题时为 "标题_"<br>无标题时为空字符串 |
| timestamp | 字符串 | 录制开始时间 | 格式：YYYY-MM-DD_HH-MM-SS |
| extension | 字符串 | 文件扩展名 | 根据录制设置（如 ts、mp4 等） |

### 2.3 平台处理逻辑

#### 2.3.1 抖音直播
- **dy_id**：从抖音API获取（抖音号）
- **room_id**：从抖音API获取或从URL提取
- **示例**：`123456789_123456789_主播名称_直播标题_2024-01-25_12-00-00.ts`

#### 2.3.2 快手直播
- **dy_id**：使用 user_id（快手账号ID）
- **room_id**：从快手API获取或从URL提取
- **示例**：`user987_room654_主播名称_直播标题_2024-01-25_12-00-00.ts`

#### 2.3.3 小红书直播
- **dy_id**：使用 user_id（小红书账号ID）
- **room_id**：从小红书API获取或从URL提取
- **示例**：`user123_room456_主播名称_直播标题_2024-01-25_12-00-00.ts`

#### 2.3.4 其他平台
- **dy_id**：使用 room_id 作为近似值
- **room_id**：从各平台API获取或从URL提取
- **示例**：`room123_room123_主播名称_直播标题_2024-01-25_12-00-00.ts`

### 2.4 分段录制命名

当启用分段录制时，文件命名格式为：

```
{dy_id}_{room_id}_{anchor_name}_{title_in_name}_{timestamp}_%03d.{extension}
```

其中 `%03d` 会被替换为序号（如 001、002 等）。

## 3. 弹幕文件命名规则

### 3.1 基本格式

弹幕文件与对应视频文件使用相同的命名规则，仅扩展名不同：

```
{dy_id}_{room_id}_{anchor_name}_{title_in_name}_{timestamp}.danmu.json
```

### 3.2 与视频文件的关联

- **存储位置**：弹幕文件与视频文件存储在同一目录
- **文件名**：仅扩展名不同，确保一一对应
- **格式**：使用 JSON Lines 格式，便于后续处理

### 3.3 示例

| 视频文件 | 弹幕文件 |
|---------|----------|
| `123456789_123456789_主播名称_直播标题_2024-01-25_12-00-00.ts` | `123456789_123456789_主播名称_直播标题_2024-01-25_12-00-00.danmu.json` |
| `987654321_987654321_主播名称_直播标题_2024-01-25_12-00-00.ts` | `987654321_987654321_主播名称_直播标题_2024-01-25_12-00-00.danmu.json` |

## 4. 变量获取逻辑

### 4.1 room_id 获取

1. **优先从平台API获取**：通过调用各平台的API接口获取房间ID
2. **从URL提取**：当API获取失败时，从直播URL中提取
3. **默认值**：如果以上方式都失败，使用 "None"

### 4.2 dy_id 获取

1. **抖音平台**：
   - 优先从抖音API获取
   - 失败时从URL提取
   - 再次失败时使用 "None"

2. **小红书和快手平台**：
   - 优先从各平台API获取 user_id
   - 失败时使用 "None"

3. **其他平台**：
   - 直接使用 room_id 作为近似值

### 4.3 anchor_name 获取

- 从各平台API获取主播名称
- 清理特殊字符，确保文件名合法

### 4.4 title_in_name 获取

- 从各平台API获取直播标题
- 清理特殊字符
- 有标题时添加下划线后缀（如 "标题_"）
- 无标题时为空字符串

## 5. 文件名清理规则

为确保文件名合法，系统会对以下内容进行清理：

1. **特殊字符**：替换为下划线
2. **空格**：替换为下划线
3. **长度限制**：确保文件名长度合理
4. **表情符号**：根据配置决定是否保留

### 5.1 清理函数

使用 `clean_name` 函数处理主播名称和标题：

```python
def clean_name(input_text):
    cleaned_name = re.sub(rstr, "_", input_text.strip()).strip('_')
    cleaned_name = cleaned_name.replace("（", "(").replace("）", ")")
    if clean_emoji:
        cleaned_name = utils.remove_emojis(cleaned_name, '_').strip('_')
    return cleaned_name or '空白昵称'
```

## 6. 目录结构

录制文件存储在以下目录结构中：

```
{default_path}/{platform}/{anchor_name}/{date}/{filename}
```

- **default_path**：默认存储路径（如 "downloads"）
- **platform**：平台名称（如 "抖音直播"）
- **anchor_name**：主播名称（可选，根据配置）
- **date**：录制日期（可选，根据配置）

## 7. 分段录制处理

当启用分段录制时：

1. **文件名格式**：添加 `_%03d` 后缀（如 `..._2024-01-25_12-00-00_%03d.ts`）
2. **序号递增**：从 001 开始，每个分段递增
3. **弹幕文件**：仍为单个文件，包含所有分段的弹幕

## 8. 平台特定处理示例

### 8.1 抖音直播

**输入**：
- URL: `https://live.douyin.com/123456789`
- 主播："抖音主播"
- 标题："直播标题"
- 时间：2024-01-25 12:00:00

**输出**：
- 视频：`123456789_123456789_抖音主播_直播标题_2024-01-25_12-00-00.ts`
- 弹幕：`123456789_123456789_抖音主播_直播标题_2024-01-25_12-00-00.danmu.json`

### 8.2 快手直播

**输入**：
- URL: `https://live.kuaishou.com/987654321`
- 主播："快手主播"
- 标题："直播标题"
- 时间：2024-01-25 12:00:00

**输出**：
- 视频：`987654321_987654321_快手主播_直播标题_2024-01-25_12-00-00.ts`
- 弹幕：`987654321_987654321_快手主播_直播标题_2024-01-25_12-00-00.danmu.json`

### 8.3 小红书直播

**输入**：
- URL: `https://www.xiaohongshu.com/live/abcdefg`
- 主播："小红书主播"
- 标题："直播标题"
- 时间：2024-01-25 12:00:00

**输出**：
- 视频：`abcdefg_abcdefg_小红书主播_直播标题_2024-01-25_12-00-00.ts`
- 弹幕：`abcdefg_abcdefg_小红书主播_直播标题_2024-01-25_12-00-00.danmu.json`

### 8.4 无标题情况

**输入**：
- URL: `https://live.douyin.com/123456789`
- 主播："抖音主播"
- 标题：无
- 时间：2024-01-25 12:00:00

**输出**：
- 视频：`123456789_123456789_抖音主播__2024-01-25_12-00-00.ts`
- 弹幕：`123456789_123456789_抖音主播__2024-01-25_12-00-00.danmu.json`

## 9. 命名规则的优势

### 9.1 一致性
- 所有平台使用统一的命名格式
- 变量个数保持一致
- 便于批量处理和管理

### 9.2 信息完整性
- 包含平台、房间、主播、标题等关键信息
- 时间戳确保唯一性
- 便于后续检索和分析

### 9.3 平台适应性
- 针对不同平台的特性进行处理
- 抖音平台使用特定标识符
- 其他平台使用通用逻辑

### 9.4 可扩展性
- 新平台可以轻松集成到现有命名规则中
- 变量结构清晰，易于理解和修改

## 10. 代码实现

### 10.1 变量获取代码

```python
# 变量获取逻辑
live_title = port_info.get('title')
room_id = port_info.get('room_id', 'None')

# 对于不同平台处理 dy_id
if platform == '抖音直播':
    dy_id = port_info.get('dy_id', 'None')
elif platform == '小红书直播' or platform == '快手直播':
    # 小红书和快手平台使用 user_id 作为账号ID
    dy_id = port_info.get('user_id', 'None')
else:
    # 其他平台使用 room_id 作为近似值
    dy_id = room_id

title_in_name = ''
if live_title:
    live_title = clean_name(live_title)
    title_in_name = live_title + '_' if filename_by_title else ''
```

### 10.2 文件名构建代码

```python
# 构建文件名
now = datetime.datetime.today().strftime("%Y-%m-%d_%H-%M-%S")

if split_video_by_time:
    # 分段录制
    filename = f'{dy_id}_{room_id}_{anchor_name}_{title_in_name}_' + now + ".ts"
    save_file_path = f"{full_path}/{dy_id}_{room_id}_{anchor_name}_{title_in_name}_{now}_%03d.ts"
else:
    # 完整录制
    filename = f'{dy_id}_{room_id}_{anchor_name}_{title_in_name}_' + now + ".{extension}"
    save_file_path = f"{full_path}/{filename}"
```

### 10.3 弹幕文件命名代码

```python
# 弹幕文件命名
danmaku_filename = f"{full_path}/{dy_id}_{room_id}_{anchor_name}_{title_in_name}_{now}.danmu.json"
```

## 11. 注意事项

1. **文件名长度**：确保文件名长度合理，避免超过系统限制
2. **特殊字符**：注意清理可能导致文件名问题的特殊字符
3. **平台API变化**：关注平台API变化，及时更新变量获取逻辑
4. **兼容性**：确保命名规则在不同操作系统上都能正常工作
5. **唯一性**：通过时间戳确保文件名唯一性，避免覆盖

## 12. 后续优化

1. **配置化**：将命名规则配置化，允许用户自定义
2. **模板支持**：支持用户定义文件名模板
3. **批量重命名**：提供批量重命名工具
4. **元数据存储**：考虑使用元数据文件存储更详细的信息

---

**总结**：本命名规则设计兼顾了一致性、信息完整性和平台适应性，确保录制文件命名规范、清晰、易于管理。通过统一的变量结构和平台特定处理，实现了对多平台直播的有效支持。